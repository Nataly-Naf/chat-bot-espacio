const { Markup } = require("telegraf");
const mainMenu = require("./mainMenu");
require('dotenv').config();  // –î–æ–¥–∞—î –ø—ñ–¥—Ç—Ä–∏–º–∫—É –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è .env —Ñ–∞–π–ª—É

const channelId = process.env.CHANNEL_ID;

module.exports = (bot) => {
    // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–•–æ—á—É –Ω–∞–≤—á–∞—Ç–∏—Å—å"
    bot.hears("–•–æ—á—É –Ω–∞–≤—á–∞—Ç–∏—Å—å üë®‚Äçüéì", (ctx) => {
        console.log("–•–æ—á—É –Ω–∞–≤—á–∞—Ç–∏—Å—è –Ω–∞—Ç–∏—Å–Ω—É—Ç–∞");

        ctx.reply(
            "üìã *–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ª–∏—à—Ç–µ —Å–≤–æ—é –∑–∞—è–≤–∫—É —É —Ç–∞–∫–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ:* \n\n" +
            "1Ô∏è‚É£ *–Ü–º'—è*\n" +
            "2Ô∏è‚É£ *–í–∞—à –∫–æ–Ω—Ç–∞–∫—Ç –≤ —Ç–µ–ª–µ–≥—Ä–∞–º—ñ (–∞–±–æ —ñ–Ω—à–∏–π –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è –∑–≤'—è–∑–∫—É)*\n" +
            "3Ô∏è‚É£ *–ö–æ–º–µ–Ω—Ç–∞—Ä* _(–∑–∞ –±–∞–∂–∞–Ω–Ω—è–º)_\n\n" +
            "üìû –ù–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä –∑–≤'—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º!",
            { parse_mode: "Markdown" }
        );

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å–µ—Å—ñ—ó, —è–∫—â–æ —ó—ó —â–µ –Ω–µ–º–∞—î
        if (!ctx.session) ctx.session = {};

        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω —Å–µ—Å—ñ—ó
        ctx.session.state = "awaiting_application";
    });

    // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è —Ç–µ–∫—Å—Ç—É
    bot.on("text", (ctx) => {
        // –Ø–∫—â–æ —Å–µ—Å—ñ—è –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞ –∞–±–æ –Ω–µ–º–∞—î —Å—Ç–∞–Ω—É "awaiting_application", –≤–∏—Ö–æ–¥–∏–º–æ
        if (!ctx.session || ctx.session.state !== "awaiting_application") {
            console.log("–°—Ç–∞–Ω —Å–µ—Å—ñ—ó –Ω–µ 'awaiting_application'. –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è —ñ–Ω—à–∞ –¥—ñ—è.");
            ctx.reply("–í–∏ –∑–∞—Ä–∞–∑ –Ω–µ –Ω–∞–¥—Å–∏–ª–∞—î—Ç–µ –∑–∞—è–≤–∫—É. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å '–•–æ—á—É –Ω–∞–≤—á–∞—Ç–∏—Å—å üë®‚Äçüéì', —â–æ–± –ø–æ—á–∞—Ç–∏.");
            return;
        }

        const application = ctx.message.text;

        // –ù–∞–¥—Å–∏–ª–∞—î–º–æ –∑–∞—è–≤–∫—É –¥–æ –∫–∞–Ω–∞–ª—É
        bot.telegram.sendMessage(channelId, `–ù–æ–≤–∞ –∑–∞—è–≤–∫–∞:\n${application}`)
            .then(() => {
                ctx.reply("–î—è–∫—É—î–º–æ! –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞–¥—ñ—Å–ª–∞–Ω–∞.", mainMenu());
                ctx.session.state = null; // –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∞–Ω —Å–µ—Å—ñ—ó –ø—ñ—Å–ª—è –æ–±—Ä–æ–±–∫–∏ –∑–∞—è–≤–∫–∏
            })
            .catch(error => {
                console.error("–ü–æ–º–∏–ª–∫–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∑–∞—è–≤–∫–∏ –¥–æ –∫–∞–Ω–∞–ª—É:", error);
                ctx.reply("–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—ñ –∑–∞—è–≤–∫–∏. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.");
            });
    });
};
